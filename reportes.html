<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reporte de Transacciones Sospechosas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-2 d-none d-md-block sidebar p-3">
          <h4 class="text-white">Detector de anomalías</h4>
          <ul class="nav flex-column mt-4">
            <li class="nav-item">
              <a class="nav-link" href="index.html"
                ><i class="bi bi-speedometer2"></i> Inicio</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#"
                ><i class="bi bi-bar-chart"></i> Reportes</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/transacciones.html"
                ><i class="bi bi-cash-coin"></i> Transacciones</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/clientes.html"
                ><i class="bi bi-people"></i> Clientes</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/cajeros.html"
                ><i class="bi bi-device-ssd"></i> Cajeros</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/tipos_transacciones.html"
                ><i class="bi bi-wallet"></i> Tipos de transacciones</a
              >
            </li>
          </ul>
        </nav>
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <nav
            class="navbar navbar-expand-lg navbar-light bg-light my-3 rounded shadow-sm"
          >
            <div class="container-fluid">
              <a class="navbar-brand" href="#">Reportes</a>
            </div>
          </nav>

          <div class="d-flex justify-content-start mb-4">
            <div class="btn-group" role="group" id="view-toggle-buttons">
              <input
                type="radio"
                class="btn-check"
                name="view-radio"
                id="view-transacciones"
                autocomplete="off"
                checked
              />
              <label class="btn btn-outline-primary" for="view-transacciones"
                >Transacciones Sospechosas</label
              >

              <input
                type="radio"
                class="btn-check"
                name="view-radio"
                id="view-clientes"
                autocomplete="off"
              />
              <label class="btn btn-outline-primary" for="view-clientes"
                >Clientes Sospechosos</label
              >
            </div>
          </div>

          <div id="transacciones-search" class="card shadow-sm mb-3">
            <div class="card-body">
              <div class="row g-2">
                <div class="col-md-10">
                  <div class="input-group">
                    <span class="input-group-text"
                      ><i class="bi bi-search"></i
                    ></span>
                    <input
                      type="text"
                      id="searchInputTransacciones"
                      class="form-control"
                      placeholder="Buscar en transacciones por ID, cliente, cajero, monto, fecha o motivo..."
                    />
                  </div>
                </div>
                <div class="col-md-2">
                  <button
                    id="btnLimpiarTransacciones"
                    class="btn btn-outline-secondary w-100"
                  >
                    <i class="bi bi-x-circle"></i> Limpiar
                  </button>
                </div>
              </div>
              <small
                id="searchInfoTransacciones"
                class="text-muted mt-2 d-block"
              ></small>
            </div>
          </div>
          
          <div id="transacciones-filters" class="card shadow-sm mb-3">
            <div class="card-header">
                <i class="bi bi-filter"></i> Filtros Adicionales
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                    <label for="filterMontoMin" class="form-label small">Monto Mínimo</label>
                    <input type="number" id="filterMontoMin" class="form-control form-control-sm" placeholder="Ej: 1000">
                </div>
                <div class="col-md-3">
                    <label for="filterMontoMax" class="form-label small">Monto Máximo</label>
                    <input type="number" id="filterMontoMax" class="form-control form-control-sm" placeholder="Ej: 5000">
                </div>
                <div class="col-md-3">
                    <label for="filterFechaDesde" class="form-label small">Fecha Desde</label>
                    <input type="date" id="filterFechaDesde" class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <label for="filterFechaHasta" class="form-label small">Fecha Hasta</label>
                    <input type="date" id="filterFechaHasta" class="form-control form-control-sm">
                </div>
                <div class="col-md-12">
                    <label for="filterMotivo" class="form-label small">Motivo de Sospecha</label>
                    <input type="text" id="filterMotivo" class="form-control form-control-sm" placeholder="Buscar por palabra clave en motivo (Ej: nocturno, z-score, lof)">
                </div>
                <div class="col-md-12 d-flex justify-content-end gap-2">
                    <button id="btnLimpiarFiltros" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Limpiar Filtros
                    </button>
                    <button id="btnAplicarFiltros" class="btn btn-sm btn-primary">
                        <i class="bi bi-check-lg"></i> Aplicar Filtros
                    </button>
                </div>
              </div>
            </div>
          </div>
          <div
            id="clientes-search"
            class="card shadow-sm mb-3"
            style="display: none"
          >
            <div class="card-body">
              <div class="row g-2">
                <div class="col-md-10">
                  <div class="input-group">
                    <span class="input-group-text"
                      ><i class="bi bi-search"></i
                    ></span>
                    <input
                      type="text"
                      id="searchInputClientes"
                      class="form-control"
                      placeholder="Buscar en clientes por ID, nombre, apellido o motivo..."
                    />
                  </div>
                </div>
                <div class="col-md-2">
                  <button
                    id="btnLimpiarClientes"
                    class="btn btn-outline-secondary w-100"
                  >
                    <i class="bi bi-x-circle"></i> Limpiar
                  </button>
                </div>
              </div>
              <small
                id="searchInfoClientes"
                class="text-muted mt-2 d-block"
              ></small>
            </div>
          </div>

          <div id="transacciones-view">
            <div class="card shadow-sm">
              <div class="card-header bg-primary text-white">
                <i class="bi bi-table"></i> Transacciones Anómalas Detectadas
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>#</th>
                        <th>ID Transacción</th>
                        <th>Cliente</th>
                        <th>ID Cajero</th>
                        <th>Monto</th>
                        <th>Fecha y Hora</th>
                        <th>Score Anomalia</th>
                        <th>Sospechosa Por</th>
                      </tr>
                    </thead>
                    <tbody id="transacciones-tbody">
                      </tbody>
                  </table>
                </div>

                <nav>
                  <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>
                <div
                  id="pagination-info"
                  class="text-center text-muted small mt-2"
                ></div>
              </div>
            </div>
          </div>

          <div id="clientes-view" style="display: none">
            <div class="card shadow-sm">
              <div class="card-header bg-success text-white">
                <i class="bi bi-people"></i> Clientes con Mayor Riesgo
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>#</th>
                        <th>ID Cliente</th>
                        <th>Nombre del Cliente</th>
                        <th>Sospechoso Por</th>
                      </tr>
                    </thead>
                    <tbody id="clientes-tbody">
                      </tbody>
                  </table>
                </div>
                <nav>
                  <ul
                    class="pagination justify-content-center"
                    id="clientes-pagination"
                  >
                    </ul>
                </nav>
                <div
                  id="clientes-pagination-info"
                  class="text-center text-muted small mt-2"
                ></div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Configuración de la API y paginación
      const API_BASE_URL = "http://127.0.0.1:8000/anomalias";
      const API_ENDPOINT = "/transacciones_sospechosas";
      const API_CLIENTES = "/clientes_sospechosos";

      // LÍMITES
      const API_LIMIT = 5000;
      const DISPLAY_LIMIT = 10;

      // ESTADO GLOBAL
      let allSuspiciousTransactions = [];
      let allSuspiciousClients = [];
      let currentDisplayPage = 1;
      let currentClientesPage = 1;

      // Variables para búsqueda en frontend
      let filteredTransactions = [];
      let filteredClients = [];
      let isDataLoadedTransacciones = false;
      let isDataLoadedClientes = false;

      // Funcion para que muestre el spinner de carga en transacciones 
      function showTransaccionesLoading(isLoading) {
        const tbody = document.getElementById("transacciones-tbody");
        if (isLoading) {
          tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Cargando transacciones...</p></td></tr>`;
        } else if (tbody.innerHTML.includes("spinner-border")) {
          // Si deja de cargar y no hay nada, mostrar msj vacío
          tbody.innerHTML = `<tr><td colspan="8" class="text-center text-secondary py-4">No se encontraron transacciones sospechosas.</td></tr>`;
        }
      }

      // Función para cargar todas las transacciones sospechosas
      async function loadAllTransacciones(forceReload = false) {
        // No recargar si ya están los datos Y no se está forzando
        if (isDataLoadedTransacciones && !forceReload) return;

        showTransaccionesLoading(true);

        try {
          let totalRecords = 5000; // Valor por defecto

          try {
            // Intentar obtener el total de registros
            const countRes = await fetch(`${API_BASE_URL}/cantidad_transacciones_sospechosas`);
            if (countRes.ok) {
              const countData = await countRes.json();
              totalRecords =
                countData.total || countData.count || countData.length || 5000;
              console.log(`Total de registros obtenido: ${totalRecords}`);
            } else {
              console.warn(
                "Endpoint /count no disponible, usando valor por defecto"
              );
            }
          } catch (countError) {
            console.warn(
              "Error obteniendo conteo, usando valor por defecto:",
              countError
            );
          }

          // Logica de filtros
          const montoMin = document.getElementById("filterMontoMin").value;
          const montoMax = document.getElementById("filterMontoMax").value;
          const fechaDesde = document.getElementById("filterFechaDesde").value;
          const fechaHasta = document.getElementById("filterFechaHasta").value;
          const motivo = document.getElementById("filterMotivo").value.trim();

          let queryParams = new URLSearchParams();
          queryParams.append("skip", 0);
          queryParams.append("limit", totalRecords); // Cargar todos los que coincidan
          if (montoMin) queryParams.append("monto_min", montoMin);
          if (montoMax) queryParams.append("monto_max", montoMax);
          if (fechaDesde) queryParams.append("fecha_desde", fechaDesde);
          if (fechaHasta) queryParams.append("fecha_hasta", fechaHasta);
          if (motivo) queryParams.append("motivo", motivo);

          // Usar la URL con query params de filtros
          const url = `${API_BASE_URL}${API_ENDPOINT}?${queryParams.toString()}`;
          console.log(`Fetching from: ${url}`);
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(
              `Error al cargar datos: ${response.status} ${response.statusText}`
            );
          }

          allSuspiciousTransactions = await response.json();
          isDataLoadedTransacciones = true;

          console.log(
            `✅ Cargadas ${allSuspiciousTransactions.length} transacciones sospechosas en memoria`
          );
          
        
        } catch (error) {
          console.error("Error cargando transacciones:", error);
          showError(
            "No se pudieron cargar las transacciones sospechosas. Verifique la conexión con el servidor."
          );

          showTransaccionesLoading(false); 
          allSuspiciousTransactions = getSampleTransacciones();
          isDataLoadedTransacciones = true;

        } finally {
            // Siempre llamar a performSearch después de cargar
            // Esto aplica el filtro de búsqueda de texto a los nuevos datos y renderiza
            performSearchTransacciones();
        }
      }

      // Función para cargar todos los clientes sospechosos
      async function loadAllClientes() {
        if (isDataLoadedClientes) return;

        try {
          const url = `${API_BASE_URL}${API_CLIENTES}`;
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(
              `Error al cargar datos: ${response.status} ${response.statusText}`
            );
          }

          allSuspiciousClients = await response.json();
          filteredClients = [...allSuspiciousClients];
          isDataLoadedClientes = true;

          console.log(
            `✅ Cargados ${allSuspiciousClients.length} clientes sospechosos en memoria`
          );

          // Renderizar la tabla
          renderClientesTableAndPagination();
        } catch (error) {
          console.error("Error cargando clientes:", error);
          showError(
            "No se pudieron cargar los clientes sospechosos. Verifique la conexión con el servidor."
          );

          // Mostrar datos de ejemplo en caso de error
          allSuspiciousClients = getSampleClientes();
          filteredClients = [...allSuspiciousClients];
          isDataLoadedClientes = true;
          renderClientesTableAndPagination();
        }
      }

      // Datos de ejemplo para transacciones
      function getSampleTransacciones() {
        return [
          {
            id: "T001",
            fecha_hora: "2024-01-15 10:30:00",
            id_cliente: "C001",
            nombre: "Juan",
            apellido: "Pérez",
            id_cajero: "CAJ01",
            monto: 500.0,
            score_anomalia: 0.95,
            sospechosa_por: ["Monto muy alto", "Horario inusual"],
          },
          {
            id: "T002",
            fecha_hora: "2024-01-15 11:15:00",
            id_cliente: "C002",
            nombre: "María",
            apellido: "González",
            id_cajero: "CAJ02",
            monto: 1200.0,
            score_anomalia: 0.87,
            sospechosa_por: ["Frecuencia inusual"],
          },
        ];
      }

      // Datos de ejemplo para clientes
      function getSampleClientes() {
        return [
          {
            id_cliente: "C001",
            nombre: "Juan",
            apellido: "Pérez",
            sospechoso_por: [
              "Múltiples transacciones sospechosas",
              "Patrón de actividad inusual",
            ],
          },
        ];
      }

      // Búsqueda en transacciones
      // ahora filtra la data en 'allSuspiciousTransactions' y llama a renderizar.
      function performSearchTransacciones() {
        const searchQuery = document
          .getElementById("searchInputTransacciones")
          .value.trim()
          .toLowerCase();

        if (!searchQuery) {
          filteredTransactions = [...allSuspiciousTransactions];
          document.getElementById("searchInfoTransacciones").innerHTML = "";
        } else {
          filteredTransactions = allSuspiciousTransactions.filter(
            (transaccion) => {
              return (
                transaccion.id.toLowerCase().includes(searchQuery) ||
                (transaccion.nombre &&
                  transaccion.nombre.toLowerCase().includes(searchQuery)) ||
                (transaccion.apellido &&
                  transaccion.apellido.toLowerCase().includes(searchQuery)) ||
                (transaccion.id_cliente &&
                  transaccion.id_cliente.toLowerCase().includes(searchQuery)) ||
                (transaccion.id_cajero &&
                  transaccion.id_cajero.toLowerCase().includes(searchQuery)) ||
                (transaccion.monto &&
                  transaccion.monto.toString().includes(searchQuery)) ||
                (transaccion.fecha_hora &&
                  transaccion.fecha_hora.toLowerCase().includes(searchQuery)) ||
                (transaccion.sospechosa_por &&
                  transaccion.sospechosa_por.some((motivo) =>
                    motivo.toLowerCase().includes(searchQuery)
                  ))
              );
            }
          );

          document.getElementById(
            "searchInfoTransacciones"
          ).innerHTML = `<i class="bi bi-info-circle"></i> Encontradas <strong>${
            filteredTransactions.length
          }</strong> transacción(es) sospechosa(s) para "<strong>${escapeHtml(
            searchQuery
          )}</strong>"`;
        }

        currentDisplayPage = 1;
        renderTransaccionesTableAndPagination();
      }

      // Búsqueda en clientes
      function performSearchClientes() {
        const searchQuery = document
          .getElementById("searchInputClientes")
          .value.trim()
          .toLowerCase();

        if (!searchQuery) {
          filteredClients = [...allSuspiciousClients];
          document.getElementById("searchInfoClientes").innerHTML = "";
        } else {
          filteredClients = allSuspiciousClients.filter((cliente) => {
            return (
              cliente.id_cliente.toLowerCase().includes(searchQuery) ||
              (cliente.nombre &&
                cliente.nombre.toLowerCase().includes(searchQuery)) ||
              (cliente.apellido &&
                cliente.apellido.toLowerCase().includes(searchQuery)) ||
              (cliente.sospechoso_por &&
                cliente.sospechoso_por.some((motivo) =>
                  motivo.toLowerCase().includes(searchQuery)
                ))
            );
          });

          document.getElementById(
            "searchInfoClientes"
          ).innerHTML = `<i class="bi bi-info-circle"></i> Encontrados <strong>${
            filteredClients.length
          }</strong> cliente(s) sospechoso(s) para "<strong>${escapeHtml(
            searchQuery
          )}</strong>"`;
        }

        currentClientesPage = 1;
        renderClientesTableAndPagination();
      }

      // Limpiar búsqueda de transacciones
      function clearSearchTransacciones() {
        document.getElementById("searchInputTransacciones").value = "";
        performSearchTransacciones();
      }

      // Limpiar búsqueda de clientes
      function clearSearchClientes() {
        document.getElementById("searchInputClientes").value = "";
        performSearchClientes();
      }

      // Renderizar tabla de transacciones con paginación
      function renderTransaccionesTableAndPagination() {
        const totalSuspicious = filteredTransactions.length;
        const totalDisplayPages = Math.ceil(totalSuspicious / DISPLAY_LIMIT);

        showTransaccionesLoading(false);

        if (totalSuspicious === 0) {
          const tbody = document.getElementById("transacciones-tbody");
          tbody.innerHTML = `<tr><td colspan="8" class="text-center text-secondary py-4">No se encontraron transacciones sospechosas.</td></tr>`;
          document.getElementById("pagination").innerHTML = "";
          document.getElementById(
            "pagination-info"
          ).textContent = `Mostrando 0 resultados`;
          return;
        }

        const start = (currentDisplayPage - 1) * DISPLAY_LIMIT;
        const end = start + DISPLAY_LIMIT;
        const transactionsToShow = filteredTransactions.slice(start, end);

        renderTransaccionesTable(transactionsToShow, start);
        renderTransaccionesPagination(totalSuspicious, totalDisplayPages);
      }

      // Renderizar tabla de clientes con paginación
      function renderClientesTableAndPagination() {
        const totalClientes = filteredClients.length;
        const totalDisplayPages = Math.ceil(totalClientes / DISPLAY_LIMIT);

        if (totalClientes === 0) {
          const tbody = document.getElementById("clientes-tbody");
          tbody.innerHTML = `<tr><td colspan="8" class="text-center text-secondary py-4">No se encontraron clientes sospechosos.</td></tr>`;
          document.getElementById("clientes-pagination").innerHTML = "";
          document.getElementById(
            "clientes-pagination-info"
          ).textContent = `Mostrando 0 resultados`;
          return;
        }

        const start = (currentClientesPage - 1) * DISPLAY_LIMIT;
        const end = start + DISPLAY_LIMIT;
        const clientesToShow = filteredClients.slice(start, end);

        renderClientesTable(clientesToShow, start);
        renderClientesPagination(totalClientes, totalDisplayPages);
      }

      // Renderizar tabla de transacciones
      function renderTransaccionesTable(transactions, startOffset) {
        const tbody = document.getElementById("transacciones-tbody");
        tbody.innerHTML = "";

        transactions.forEach((t, index) => {
          const absoluteIndex = startOffset + index + 1;
          const scorePercentage = (t.score_anomalia * 100).toFixed(2);

          let scoreClass = "text-success";
          if (t.score_anomalia >= 0.75) {
            scoreClass = "text-danger fw-bold";
          } else if (t.score_anomalia >= 0.5) {
            scoreClass = "text-warning";
          }

          const row = `
                    <tr>
                        <td>${absoluteIndex}</td>
                        <td class="small">${escapeHtml(t.id)}</td>
                        <td>${escapeHtml(t.nombre)} ${escapeHtml(
            t.apellido
          )} <span class="text-muted small">(${escapeHtml(
            t.id_cliente
          )})</span></td>
                        <td>${escapeHtml(t.id_cajero)}</td>
                        <td class="fw-bold">$${escapeHtml(t.monto)}</td>
                        <td>${formatDateTime(t.fecha_hora)}</td>
                        <td class="${scoreClass}">${scorePercentage}%</td>
                        <td>
                            <ul class="list-unstyled mb-0 small">
                                ${t.sospechosa_por
                                  .map(
                                    (m) =>
                                      `<li><i class="bi bi-dot"></i> ${escapeHtml(
                                        m
                                      )}</li>`
                                  )
                                  .join("")}
                            </ul>
                        </td>
                    </tr>
                `;
          tbody.insertAdjacentHTML("beforeend", row);
        });
      }

      // Renderizar tabla de clientes
      function renderClientesTable(clients, startOffset) {
        const tbody = document.getElementById("clientes-tbody");
        tbody.innerHTML = "";

        clients.forEach((c, index) => {
          const absoluteIndex = startOffset + index + 1;

          const row = `
                    <tr>
                        <td>${absoluteIndex}</td>
                        <td class="small fw-bold">${escapeHtml(
                          c.id_cliente
                        )}</td>
                        <td>${escapeHtml(c.nombre)} ${escapeHtml(
            c.apellido
          )}</td>
              <td>
                  <ul class="list-unstyled mb-0 small">
                      ${c.sospechoso_por
                        .map(
                          (m) =>
                            `<li><i class="bi bi-dot"></i> ${escapeHtml(
                              m
                            )}</li>`
                        )
                        .join("")}
                  </ul>
              </td>
          </tr>
          `;
          tbody.insertAdjacentHTML("beforeend", row);
        });
      }

      // Renderizar paginación de transacciones
      function renderTransaccionesPagination(
        totalSuspicious,
        totalDisplayPages
      ) {
        const paginationEl = document.getElementById("pagination");
        const paginationInfoEl = document.getElementById("pagination-info");
        paginationEl.innerHTML = "";

        const startDisplay = (currentDisplayPage - 1) * DISPLAY_LIMIT + 1;
        const endDisplay = Math.min(
          startDisplay + DISPLAY_LIMIT - 1,
          totalSuspicious
        );
        paginationInfoEl.textContent = `Mostrando resultados ${startDisplay} - ${endDisplay} de ${totalSuspicious} transacciones sospechosas`;

        if (totalDisplayPages <= 1) {
          return;
        }

        const createPageItem = (
          text,
          page,
          isActive = false,
          isDisabled = false
        ) => {
          const li = document.createElement("li");
          li.className = `page-item ${isActive ? "active" : ""} ${
            isDisabled ? "disabled" : ""
          }`;

          const a = document.createElement("a");
          a.href = "#";
          a.className = "page-link";
          a.textContent = text;
          a.setAttribute("data-page", page);

          if (!isDisabled) {
            a.addEventListener("click", (e) => {
              e.preventDefault();
              const newPage = parseInt(e.target.getAttribute("data-page"));
              if (newPage !== currentDisplayPage) {
                currentDisplayPage = newPage;
                renderTransaccionesTableAndPagination();
              }
            });
          }

          li.appendChild(a);
          return li;
        };

        // Botón Anterior
        paginationEl.appendChild(
          createPageItem(
            "Anterior",
            currentDisplayPage - 1,
            false,
            currentDisplayPage === 1
          )
        );

        // Paginación de 5 botones centrada
        let startPage = Math.max(1, currentDisplayPage - 2);
        let endPage = Math.min(totalDisplayPages, currentDisplayPage + 2);

        if (currentDisplayPage <= 3) {
          endPage = Math.min(totalDisplayPages, 5);
          startPage = 1;
        } else if (currentDisplayPage > totalDisplayPages - 3) {
          startPage = Math.max(1, totalDisplayPages - 4);
          endPage = totalDisplayPages;
        }

        for (let i = startPage; i <= endPage; i++) {
          paginationEl.appendChild(
            createPageItem(i, i, i === currentDisplayPage)
          );
        }

        // Botón Siguiente
        paginationEl.appendChild(
          createPageItem(
            "Siguiente",
            currentDisplayPage + 1,
            false,
            currentDisplayPage === totalDisplayPages
          )
        );
      }

      // Renderizar paginación de clientes
      function renderClientesPagination(totalClientes, totalDisplayPages) {
        const paginationEl = document.getElementById("clientes-pagination");
        const paginationInfoEl = document.getElementById(
          "clientes-pagination-info"
        );
        paginationEl.innerHTML = "";

        const startDisplay = (currentClientesPage - 1) * DISPLAY_LIMIT + 1;
        const endDisplay = Math.min(
          startDisplay + DISPLAY_LIMIT - 1,
          totalClientes
        );
        paginationInfoEl.textContent = `Mostrando clientes ${startDisplay}-${endDisplay} de ${totalClientes}`;

        if (totalDisplayPages <= 1) {
          return;
        }

        const createPageItem = (
          text,
          page,
          isActive = false,
          isDisabled = false
        ) => {
          const li = document.createElement("li");
          li.className = `page-item ${isActive ? "active" : ""} ${
            isDisabled ? "disabled" : ""
          }`;

          const a = document.createElement("a");
          a.href = "#";
          a.className = "page-link";
          a.textContent = text;
          a.setAttribute("data-page", page);

          if (!isDisabled) {
            a.addEventListener("click", (e) => {
              e.preventDefault();
              const newPage = parseInt(e.target.getAttribute("data-page"));
              if (newPage !== currentClientesPage) {
                currentClientesPage = newPage;
                renderClientesTableAndPagination();
              }
            });
          }

          li.appendChild(a);
          return li;
        };

        // Botón Anterior
        paginationEl.appendChild(
          createPageItem(
            "Anterior",
            currentClientesPage - 1,
            false,
            currentClientesPage === 1
          )
        );

        // Paginación de 5 botones centrada
        let startPage = Math.max(1, currentClientesPage - 2);
        let endPage = Math.min(totalDisplayPages, currentClientesPage + 2);

        if (currentClientesPage <= 3) {
          endPage = Math.min(totalDisplayPages, 5);
          startPage = 1;
        } else if (currentClientesPage > totalDisplayPages - 3) {
          startPage = Math.max(1, totalDisplayPages - 4);
          endPage = totalDisplayPages;
        }

        for (let i = startPage; i <= endPage; i++) {
          paginationEl.appendChild(
            createPageItem(i, i, i === currentDisplayPage)
          );
        }

        // Botón Siguiente
        paginationEl.appendChild(
          createPageItem(
            "Siguiente",
            currentClientesPage + 1,
            false,
            currentClientesPage === totalDisplayPages
          )
        );
      }

      // Formatear fecha y hora
      function formatDateTime(dateTimeString) {
        const options = {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        };
        const date = new Date(Date.parse(dateTimeString));
        return date.toLocaleDateString("es-ES", options);
      }

      // Escapar HTML para prevenir XSS
      function escapeHtml(text) {
        if (text === null || text === undefined) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Mostrar errores
      function showError(message) {
        const existingAlerts = document.querySelectorAll(".alert");
        existingAlerts.forEach((alert) => alert.remove());

        const alert = document.createElement("div");
        alert.className = "alert alert-danger alert-dismissible fade show";
        alert.innerHTML = `
                <i class="bi bi-exclamation-triangle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
        const main = document.querySelector("main");
        const firstCard = main.querySelector(".card");
        main.insertBefore(alert, firstCard);
        setTimeout(() => {
          if (alert.parentNode) {
            alert.remove();
          }
        }, 8000);
      }

      // Cambiar entre vistas
      function switchView(viewName) {
        const transaccionesView = document.getElementById("transacciones-view");
        const clientesView = document.getElementById("clientes-view");
        const transaccionesSearch = document.getElementById(
          "transacciones-search"
        );
        const clientesSearch = document.getElementById("clientes-search");
        const transaccionesFilters = document.getElementById(
          "transacciones-filters"
        );

        if (viewName === "transacciones") {
          transaccionesView.style.display = "block";
          clientesView.style.display = "none";
          transaccionesSearch.style.display = "block";
          clientesSearch.style.display = "none";
          transaccionesFilters.style.display = "block";

          loadAllTransacciones(false);

        } else if (viewName === "clientes") {
          transaccionesView.style.display = "none";
          clientesView.style.display = "block";
          transaccionesSearch.style.display = "none";
          clientesSearch.style.display = "block";
          transaccionesFilters.style.display = "none";

          if (!isDataLoadedClientes) {
            loadAllClientes();
          } else {
            renderClientesTableAndPagination();
          }
        }
      }

      // Inicializar listeners
      function initViewListeners() {
        document
          .getElementById("view-transacciones")
          .addEventListener("change", () => switchView("transacciones"));
        document
          .getElementById("view-clientes")
          .addEventListener("change", () => switchView("clientes"));

        // Event listeners para búsqueda de transacciones
        document
          .getElementById("searchInputTransacciones")
          .addEventListener("keyup", (e) => {
            if (e.key === "Enter") {
              performSearchTransacciones();
            }
            if (e.key === "Escape") {
              clearSearchTransacciones();
            }
          });

        document
          .getElementById("btnLimpiarTransacciones")
          .addEventListener("click", clearSearchTransacciones);

        // Búsqueda en tiempo real con debounce
        let searchTimeoutTransacciones;
        document
          .getElementById("searchInputTransacciones")
          .addEventListener("input", () => {
            clearTimeout(searchTimeoutTransacciones);
            searchTimeoutTransacciones = setTimeout(() => {
              performSearchTransacciones();
            }, 400);
          });

        // Event listeners para búsqueda de clientes
        document
          .getElementById("searchInputClientes")
          .addEventListener("keyup", (e) => {
            if (e.key === "Enter") {
              performSearchClientes();
            }
            if (e.key === "Escape") {
              clearSearchClientes();
            }
          });

        document
          .getElementById("btnLimpiarClientes")
          .addEventListener("click", clearSearchClientes);

        // Búsqueda en tiempo real con debounce
        let searchTimeoutClientes;
        document
          .getElementById("searchInputClientes")
          .addEventListener("input", () => {
            clearTimeout(searchTimeoutClientes);
            searchTimeoutClientes = setTimeout(() => {
              performSearchClientes();
            }, 400);
          });

        // Listeners de filtros de transacciones
        document.getElementById("btnAplicarFiltros").addEventListener("click", () => {
            // Forzar recarga desde la API con los nuevos filtros
            loadAllTransacciones(true);
        });

        document.getElementById("btnLimpiarFiltros").addEventListener("click", () => {
            // Limpiar campos de filtro
            document.getElementById("filterMontoMin").value = "";
            document.getElementById("filterMontoMax").value = "";
            document.getElementById("filterFechaDesde").value = "";
            document.getElementById("filterFechaHasta").value = "";
            document.getElementById("filterMotivo").value = "";
            
            // Forzar recarga desde la API sin filtros
            loadAllTransacciones(true);
        });
      }

      // Inicialización de la aplicación
      window.onload = () => {
        initViewListeners();
        // Cargar transacciones por defecto
        loadAllTransacciones(false);
      };
    </script>
  </body>
</html>