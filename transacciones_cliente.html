<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transacciones Detalle Cliente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-2 d-none d-md-block sidebar p-3">
          <h4 class="text-white">Detector de anomal√≠as</h4>
          <ul class="nav flex-column mt-4">
            <li class="nav-item"> <a class="nav-link" href="index.html"><i class="bi bi-speedometer2"></i> Inicio</a> </li>
            <li class="nav-item"> <a class="nav-link" href="reportes.html"><i class="bi bi-bar-chart"></i> Reportes</a></li>
            <li class="nav-item"> <a class="nav-link" href="/transacciones.html"><i class="bi bi-cash-coin"></i> Transacciones</a></li>
            <li class="nav-item"> <a class="nav-link" href="/clientes.html"><i class="bi bi-people"></i> Clientes</a> </li>
            <li class="nav-item"> <a class="nav-link" href="/cajeros.html"><i class="bi bi-device-ssd"></i> Cajeros</a></li>
            <li class="nav-item"> <a class="nav-link" href="/tipos_transacciones.html"><i class="bi bi-wallet"></i> Tipos de transacciones</a> </li>
          </ul>
        </nav>
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <nav class="navbar navbar-expand-lg navbar-light bg-light my-3 rounded shadow-sm">
            <div class="container-fluid">
              <a class="navbar-brand">
                <i class="bi bi-person-exclamation"></i> Transacciones de Cliente: <span id="client-info" class="fw-bold">Cargando...</span>
              </a>
              <button class="btn btn-outline-secondary" onclick="window.history.back()">
                <i class="bi bi-arrow-left"></i> Volver a Clientes Sospechosos
              </button>
            </div>
          </nav>
          
          <div class="card shadow-sm mt-4">
            <div class="card-header bg-primary text-white">
              <i class="bi bi-table"></i> Historial de Transacciones Analizadas
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>#</th>
                      <th>ID Transacci√≥n</th>
                      <th>Monto</th>
                      <th>Fecha y Hora</th>
                      <th>ID Cajero</th>
                      <th>Tipo Transacci√≥n</th>
                      <th>Score Anomalia</th>
                      <th>Sospechosa Por</th>
                    </tr>
                  </thead>
                  <tbody id="transacciones-tbody">
                    <tr><td colspan="8" class="text-center text-secondary py-4">Cargando transacciones...</td></tr>
                  </tbody>
                </table>
              </div>
              <div id="data-info" class="text-center text-muted small mt-2"></div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const API_BASE_URL = "http://127.0.0.1:8000/anomalias";
      const API_TRANSACCIONES_CLIENTE = "/transacciones_por_cliente";
      
      let allClientTransactions = [];

      // Endpoint para cargar la lista de tipos de transacciones (usando la ruta /tipos_transacciones del backend)
      const apiTipos = "http://127.0.0.1:8000/tipos_transacciones/"; // Asegurarse de usar la barra al final si es necesario
      let tiposMap = {}; // Mapa para tipos de transacciones {id: nombre}

      /**
       * Carga los tipos de transacciones desde la API y crea un mapa ID -> Nombre.
       */
      async function fetchTiposTransacciones() {
        try {
          // Si la API solo devuelve un conteo o un subconjunto, podr√≠as necesitar ajustar la llamada
          const res = await fetch(apiTipos); 
          if (!res.ok) {
            console.warn("No se pudieron cargar los tipos de transacciones.");
            return;
          }
          const tipos = await res.json();
          tipos.forEach((t) => {
            // Asumiendo que cada tipo tiene { "id": int, "nombre": string }
            tiposMap[t.id] = t.nombre; 
          });
          console.log(
            `‚úÖ Cargados ${Object.keys(tiposMap).length} tipos de transacciones`
          );
        } catch (error) {
          console.error("Error cargando tipos de transacciones:", error);
        }
      }

      // Funci√≥n para obtener el ID del cliente de la URL
      function getClientIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id_cliente');
        const nombre = urlParams.get('nombre') || 'Desconocido';
        const apellido = urlParams.get('apellido') || '';
        return { id, nombre, apellido };
      }

      // Funci√≥n principal para cargar las transacciones
      async function loadClientTransactions(clientId) {
        document.getElementById('transacciones-tbody').innerHTML = `<tr><td colspan="8" class="text-center text-info py-4"><div class="spinner-border spinner-border-sm text-info me-2" role="status"></div> Analizando las transacciones del cliente...</td></tr>`;

        try {
          const url = `${API_BASE_URL}${API_TRANSACCIONES_CLIENTE}/${clientId}`;
          const response = await fetch(url);

          if (!response.ok) {
            if (response.status === 404) {
                 throw new Error(`No se encontraron transacciones para este cliente (${clientId}).`);
            }
            throw new Error(`Error al cargar datos: ${response.status} ${response.statusText}`);
          }

          allClientTransactions = await response.json();
          // Aseguramos que el mapa de tipos est√© cargado antes de renderizar
          renderTransaccionesTable(allClientTransactions); 
          document.getElementById('data-info').textContent = `Mostrando ${allClientTransactions.length} transacciones.`;

        } catch (error) {
          console.error("Error cargando transacciones del cliente:", error);
          document.getElementById('transacciones-tbody').innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">Error: ${error.message}</td></tr>`;
          document.getElementById('data-info').textContent = `No hay datos disponibles.`;
        }
      }

      // Renderizar tabla de transacciones
      function renderTransaccionesTable(transactions) {
        const tbody = document.getElementById("transacciones-tbody");
        tbody.innerHTML = "";
        
        if (transactions.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-secondary py-4">No se encontraron transacciones.</td></tr>`;
            return;
        }

        // üí° Mapeo de IDs a Nombres en el Frontend
        const mappedTransactions = transactions.map((t) => {
             // Usamos el ID para buscar el NOMBRE en el mapa. Si no se encuentra, usamos el ID original.
            const tipo_nombre = tiposMap[t.id_tipo_transaccion] || t.id_tipo_transaccion;
            return {
                ...t,
                tipo_nombre: tipo_nombre,
            };
        });

        mappedTransactions.forEach((t, index) => {
          // Correcci√≥n para evitar el error 'toFixed is not a function'
          const monto_float = parseFloat(t.monto); 
          const scorePercentage = (t.score_anomalia * 100).toFixed(2);
          const isSuspicious = t.sospechosa_por.length > 0;
          
          let rowClass = isSuspicious ? 'table-danger' : '';
          let scoreClass = isSuspicious ? 'text-danger fw-bold' : 'text-success';

          const row = `
            <tr class="${rowClass}">
                <td>${index + 1}</td>
                <td class="small">${escapeHtml(t.id)}</td>
                <td class="fw-bold">$${monto_float.toFixed(2)}</td>
                <td>${formatDateTime(t.fecha_hora)}</td>
                <td>${escapeHtml(t.id_cajero)}</td>
                <td>${escapeHtml(t.tipo_nombre)}</td> <td class="${scoreClass}">${scorePercentage}%</td>
                <td>
                    ${isSuspicious ? `
                    <ul class="list-unstyled mb-0 small">
                        ${t.sospechosa_por.map(m => `<li><i class="bi bi-exclamation-triangle-fill text-danger"></i> ${escapeHtml(m)}</li>`).join("")}
                    </ul>
                    ` : '<span class="text-success">Comportamiento Normal</span>'}
                </td>
            </tr>
          `;
          tbody.insertAdjacentHTML("beforeend", row);
        });
      }

      // Funciones de utilidad (Mantenidas)
      function formatDateTime(dateTimeString) {
        const options = { year: "numeric", month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" };
        const date = new Date(Date.parse(dateTimeString));
        return date.toLocaleDateString("es-ES", options);
      }

      function escapeHtml(text) {
        if (text === null || text === undefined) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
      
      // Inicializaci√≥n de la aplicaci√≥n
      window.onload = async () => {
        const client = getClientIdFromUrl();
        const clientInfoEl = document.getElementById('client-info');
        
        // 1. Mostrar informaci√≥n del cliente inmediatamente
        if (client.id) {
            clientInfoEl.textContent = `${client.nombre} ${client.apellido} (${client.id})`;
        } else {
            clientInfoEl.textContent = 'ID de cliente no proporcionado.';
            document.getElementById('transacciones-tbody').innerHTML = `<tr><td colspan="8" class="text-center text-warning py-4">ID de cliente faltante en la URL.</td></tr>`;
            return;
        }

        // 2. Cargar el mapa de tipos de transacciones de forma as√≠ncrona
        await fetchTiposTransacciones();

        // 3. Cargar las transacciones del cliente (que ahora usar√°n el mapa)
        await loadClientTransactions(client.id);
      };
    </script>
  </body>
</html>