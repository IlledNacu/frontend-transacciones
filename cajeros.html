<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Gen√©rico</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />
    <style>
      body {
        font-size: 0.9rem;
      }

      .sidebar {
        min-height: 100vh;
        background-color: #343a40;
      }

      .sidebar .nav-link {
        color: #fff;
      }

      .sidebar .nav-link.active {
        background-color: #495057;
      }

      .search-highlight {
        background-color: #fff3cd;
        padding: 0.1rem 0.2rem;
        border-radius: 0.2rem;
      }

      .table-responsive-custom {
        max-height: 65vh;
        overflow-y: auto;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 d-none d-md-block sidebar p-3">
          <h4 class="text-white">Detector de anomal√≠as</h4>
          <ul class="nav flex-column mt-4">
            <li class="nav-item">
              <a class="nav-link" href="/index.html"
                ><i class="bi bi-speedometer2"></i> Inicio</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/reportes.html"
                ><i class="bi bi-bar-chart"></i> Reportes</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/transacciones.html"
                ><i class="bi bi-cash-coin"></i> Transacciones</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/clientes.html"
                ><i class="bi bi-people"></i> Clientes</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#"
                ><i class="bi bi-device-ssd"></i> Cajeros</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/tipos_transacciones.html"
                ><i class="bi bi-wallet"></i> Tipos de transacciones</a
              >
            </li>
          </ul>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <!-- Navbar -->
          <nav
            class="navbar navbar-expand-lg navbar-light bg-light my-3 rounded shadow-sm"
          >
            <div class="container-fluid">
              <a class="navbar-brand" href="#">Cajeros</a>
              <button
                class="btn btn-success"
                id="btnCrearCajero"
                data-bs-toggle="modal"
                data-bs-target="#createModal"
              >
                <i class="bi bi-plus-circle"></i> Crear Nuevo Cajero
              </button>
            </div>
          </nav>

          <!-- Buscador -->
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <div class="row g-2">
                <div class="col-md-10">
                  <div class="input-group">
                    <span class="input-group-text"
                      ><i class="bi bi-search"></i
                    ></span>
                    <input
                      type="text"
                      id="searchInput"
                      class="form-control"
                      placeholder="Buscar por n√∫mero, nombre, ciudad, provincia o pa√≠s..."
                    />
                  </div>
                </div>
                <div class="col-md-2">
                  <button
                    id="btnLimpiar"
                    class="btn btn-outline-secondary w-100"
                  >
                    <i class="bi bi-x-circle"></i> Limpiar
                  </button>
                </div>
              </div>
              <small id="searchInfo" class="text-muted mt-2 d-block"></small>
            </div>
          </div>

          <!-- Tabla -->
          <div class="card shadow-sm">
            <div class="card-header bg-warning">
              <i class="bi bi-device-ssd"></i> Todos los Cajeros
            </div>
            <div class="card-body">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>N√∫mero de cajero</th>
                    <th>Nombre</th>
                    <th>Ciudad</th>
                    <th>Provincia</th>
                    <th>Pa√≠s</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="cajeros-tbody">
                  <!-- JS genera tabla -->
                </tbody>
              </table>

              <nav>
                <ul class="pagination justify-content-center" id="pagination">
                  <!-- JS genera botones -->
                </ul>
              </nav>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Modal Crear Cajero -->
    <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="createForm">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Crear Cajero</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">N√∫mero de cajero</label>
                            <input type="text" class="form-control" id="createId" readonly />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="createNombre" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ciudad</label>
                            <input type="text" class="form-control" id="createCiudad" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Provincia</label>
                            <input type="text" class="form-control" id="createProvincia" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Pa√≠s</label>
                            <input type="text" class="form-control" id="createPais" required />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const apiBase = "http://127.0.0.1:8000/cajeros";
      let currentPage = 1;
      let pageSize = 30;
      let totalPages = 1;

      // Variables para b√∫squeda en frontend
      let allCajeros = []; // Almacena TODOS los datos
      let filteredCajeros = []; // Datos filtrados por b√∫squeda
      let isSearching = false; // Flag para saber si hay b√∫squeda activa
      let isDataLoaded = false; // Flag para saber si ya cargamos todos los datos

      // Cargar TODOS los cajeros (una sola vez)
      async function loadAllCajeros() {
        if (isDataLoaded) return; // Si ya est√°n cargados, no hacer nada

        try {
          let totalRecords = 1000; // Valor por defecto para el l√≠mite

          try {
            // Intentar obtener el total de registros
            const countRes = await fetch(`${apiBase}/count`);
            if (countRes.ok) {
              const countData = await countRes.json();
              // Manejar diferentes formatos de respuesta posibles
              totalRecords =
                countData.total || countData.count || countData.length || 1000;
              console.log(`Total de registros obtenido: ${totalRecords}`);
            } else {
              console.warn(
                "Endpoint /count no disponible, usando valor por defecto"
              );
            }
          } catch (countError) {
            console.warn(
              "Error obteniendo conteo, usando valor por defecto:",
              countError
            );
          }

          // Ahora traemos TODOS los registros de una vez
          console.log(`Solicitando ${totalRecords} registros...`);
          const res = await fetch(`${apiBase}/?skip=0&limit=${totalRecords}`);

          if (!res.ok) {
            // Si falla con el l√≠mite grande, intentar con un l√≠mite m√°s peque√±o
            console.warn(
              "Primera solicitud fallida, intentando con l√≠mite m√°s peque√±o..."
            );
            const fallbackRes = await fetch(`${apiBase}/?skip=0&limit=500`);
            if (!fallbackRes.ok) {
              throw new Error(
                `Error al cargar datos: ${fallbackRes.status} ${fallbackRes.statusText}`
              );
            }
            allCajeros = await fallbackRes.json();
          } else {
            allCajeros = await res.json();
          }

          filteredCajeros = [...allCajeros]; // Por defecto, mostrar todos
          isDataLoaded = true;

          console.log(`‚úÖ Cargados ${allCajeros.length} cajeros en memoria`);
        } catch (error) {
          console.error("Error cargando datos:", error);
          showError(
            "No se pudieron cargar los datos. Verifique la conexi√≥n con el servidor."
          );

          // Mostrar datos de ejemplo en caso de error
          allCajeros = getSampleData();
          filteredCajeros = [...allCajeros];
          isDataLoaded = true;
          console.log("Usando datos de ejemplo debido al error");
        }
      }

      // Datos de ejemplo para cuando la API falle
      function getSampleData() {
        return [
          {
            id: "001",
            nombre: "Cajero Centro",
            ciudad: "Madrid",
            provincia: "Madrid",
            pais: "Espa√±a",
          },
          {
            id: "002",
            nombre: "Cajero Norte",
            ciudad: "Barcelona",
            provincia: "Barcelona",
            pais: "Espa√±a",
          },
          {
            id: "003",
            nombre: "Cajero Sur",
            ciudad: "Sevilla",
            provincia: "Sevilla",
            pais: "Espa√±a",
          },
          {
            id: "004",
            nombre: "Cajero Este",
            ciudad: "Valencia",
            provincia: "Valencia",
            pais: "Espa√±a",
          },
          {
            id: "005",
            nombre: "Cajero Oeste",
            ciudad: "A Coru√±a",
            provincia: "Galicia",
            pais: "Espa√±a",
          },
          {
            id: "006",
            nombre: "Cajero Central",
            ciudad: "Zaragoza",
            provincia: "Zaragoza",
            pais: "Espa√±a",
          },
        ];
      }

      // Renderizar tabla con datos filtrados
      function renderTable() {
        const tbody = document.getElementById("cajeros-tbody");
        tbody.innerHTML = "";

        // Calcular √≠ndices para la paginaci√≥n actual
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageData = filteredCajeros.slice(startIndex, endIndex);

        if (pageData.length === 0) {
            tbody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center text-muted p-4">
                <i class="bi bi-inbox fs-1"></i>
                <p class="mb-0 mt-2">No se encontraron resultados</p>
              </td>
            </tr>
          `;
            return;
        }

        pageData.forEach((c, i) => {
            const tr = document.createElement("tr");
            const globalIndex = startIndex + i + 1;
            tr.innerHTML = `
            <td>${globalIndex}</td>
            <td data-id="${escapeHtml(c.id)}">${escapeHtml(c.id)}</td>
            <td>${escapeHtml(c.nombre)}</td>
            <td>${escapeHtml(c.ciudad)}</td>
            <td>${escapeHtml(c.provincia)}</td>
            <td>${escapeHtml(c.pais)}</td>
            <td>
                            <button class="btn btn-sm btn-outline-danger delete-btn"><i class="bi bi-trash"></i></button>
            </td>
          `;
            tbody.appendChild(tr);
        });
      }

      // Calcular total de p√°ginas
      function calculateTotalPages() {
        totalPages = Math.ceil(filteredCajeros.length / pageSize);
        if (totalPages < 1) totalPages = 1;
      }

      // Realizar b√∫squeda en el frontend
      function performSearch() {
        const searchQuery = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();

        if (!searchQuery) {
          // Si no hay b√∫squeda, mostrar todos
          filteredCajeros = [...allCajeros];
          isSearching = false;
          document.getElementById("searchInfo").innerHTML = "";
        } else {
          // Filtrar datos
          isSearching = true;
          filteredCajeros = allCajeros.filter((cajero) => {
            return (
              cajero.id.toString().toLowerCase().includes(searchQuery) ||
              (cajero.nombre &&
                cajero.nombre.toLowerCase().includes(searchQuery)) ||
              (cajero.ciudad &&
                cajero.ciudad.toLowerCase().includes(searchQuery)) ||
              (cajero.provincia &&
                cajero.provincia.toLowerCase().includes(searchQuery)) ||
              (cajero.pais && cajero.pais.toLowerCase().includes(searchQuery))
            );
          });

          // Mostrar info de resultados
          document.getElementById(
            "searchInfo"
          ).innerHTML = `<i class="bi bi-info-circle"></i> Encontrados <strong>${
            filteredCajeros.length
          }</strong> resultado(s) para "<strong>${escapeHtml(
            searchQuery
          )}</strong>"`;
        }

        // Resetear a p√°gina 1 y recalcular
        currentPage = 1;
        calculateTotalPages();
        renderTable();
        renderPagination();
      }

      // Limpiar b√∫squeda
      function clearSearch() {
        document.getElementById("searchInput").value = "";
        performSearch(); // Esto restaurar√° todos los datos
      }

      // Renderizar paginaci√≥n
      function renderPagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        if (totalPages <= 1) {
          return; // No mostrar paginaci√≥n si hay 1 o menos p√°ginas
        }

        const maxVisible = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let endPage = startPage + maxVisible - 1;

        if (endPage > totalPages) {
          endPage = totalPages;
          startPage = Math.max(1, endPage - maxVisible + 1);
        }

        // Bot√≥n "Primero"
        if (currentPage > 1) {
          pagination.appendChild(createPaginationButton("¬´ Primero", 1));
        }

        // Bot√≥n "Anterior"
        if (currentPage > 1) {
          pagination.appendChild(createPaginationButton("‚Äπ", currentPage - 1));
        }

        // Botones de p√°ginas visibles
        for (let i = startPage; i <= endPage; i++) {
          const li = document.createElement("li");
          li.className = `page-item ${i === currentPage ? "active" : ""}`;
          li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
          li.addEventListener("click", (e) => {
            e.preventDefault();
            goToPage(i);
          });
          pagination.appendChild(li);
        }

        // Bot√≥n "Siguiente"
        if (currentPage < totalPages) {
          pagination.appendChild(createPaginationButton("‚Ä∫", currentPage + 1));
        }

        // Bot√≥n "√öltimo"
        if (currentPage < totalPages) {
          pagination.appendChild(
            createPaginationButton("√öltimo ¬ª", totalPages)
          );
        }
      }

      // Helper para crear bot√≥n de paginaci√≥n
      function createPaginationButton(text, page) {
        const li = document.createElement("li");
        li.className = "page-item";
        li.innerHTML = `<a class="page-link" href="#">${text}</a>`;
        li.addEventListener("click", (e) => {
          e.preventDefault();
          goToPage(page);
        });
        return li;
      }

      // Ir a una p√°gina espec√≠fica
      function goToPage(page) {
        currentPage = page;
        renderTable();
        renderPagination();

        // Scroll suave hacia arriba
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Escapar HTML para prevenir XSS
      function escapeHtml(text) {
        if (text === null || text === undefined) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Mostrar errores
      function showError(message) {
        // Remover alertas existentes
        const existingAlerts = document.querySelectorAll(".alert");
        existingAlerts.forEach((alert) => alert.remove());

        const alert = document.createElement("div");
        alert.className = "alert alert-danger alert-dismissible fade show";
        alert.innerHTML = `
                <i class="bi bi-exclamation-triangle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
        const main = document.querySelector("main");
        const firstCard = main.querySelector(".card");
        main.insertBefore(alert, firstCard);
        setTimeout(() => {
          if (alert.parentNode) {
            alert.remove();
          }
        }, 8000);
      }

      // Mostrar loading
      function showLoading() {
        const tbody = document.getElementById("cajeros-tbody");
        tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center p-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mb-0 mt-2">Cargando datos...</p>
                    </td>
                </tr>
            `;
      }

      // Event Listeners
      document.getElementById("searchInput").addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
          performSearch();
        }
        if (e.key === "Escape") {
          clearSearch();
        }
      });

      document
        .getElementById("btnLimpiar")
        .addEventListener("click", clearSearch);

      // B√∫squeda en tiempo real con debounce
      let searchTimeout;
      document.getElementById("searchInput").addEventListener("input", () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          performSearch();
        }, 400);
      });

      // Inicializar la aplicaci√≥n
      (async () => {
        // Mostrar loading
        showLoading();

        // Cargar todos los datos
        await loadAllCajeros();

        // Calcular p√°ginas y renderizar
        calculateTotalPages();
        renderTable();
        renderPagination();
      })();
    </script>
    <script>
      let createModal = new bootstrap.Modal(document.getElementById("createModal"));
      let createForm = document.getElementById("createForm");
      let modalTitle = document.querySelector("#createModal .modal-title");
      let createIdInput = document.getElementById("createId");
      let saveButton = document.querySelector("#createForm button[type='submit']");

      // Funci√≥n para a√±adir datos en el frontend
      function addFrontendData(newCajero) {
          // A√±adir al inicio para que el usuario lo vea de inmediato
          allCajeros.unshift(newCajero); 
          
          // Si hay b√∫squeda activa, filtrar de nuevo. Si no, a√±adir tambi√©n al inicio.
          if (isSearching) {
              performSearch(); // Re-ejecuta el filtro
          } else {
              filteredCajeros.unshift(newCajero);
          }
          
          // Recalcular p√°ginas, ir a la primera p√°gina y renderizar
          calculateTotalPages();
          currentPage = 1;
          renderTable();
          renderPagination();
      }

      // Funci√≥n para eliminar en el frontend (se mantiene igual)
      function deleteFrontendData(id) {
          allCajeros = allCajeros.filter((c) => c.id != id);
          filteredCajeros = filteredCajeros.filter((c) => c.id != id);
          
          // Recalcular y renderizar
          calculateTotalPages();
          if (currentPage > totalPages && totalPages >= 1) {
              currentPage = totalPages;
          } else if (totalPages === 0) {
              currentPage = 1; 
          }
          renderTable(); 
          renderPagination();
      }

      // üÜï Abrir modal para CREAR
      document.getElementById("btnCrearCajero").addEventListener("click", () => {
          modalTitle.innerHTML = '<i class="bi bi-plus-circle"></i> Crear Nuevo Cajero';
          createForm.reset(); // Limpiar formulario
          createIdInput.removeAttribute("readonly"); // Permitir ingresar ID
          createIdInput.focus();
          saveButton.textContent = 'Crear Cajero';
      });
      
      // üóëÔ∏è Manejador para el bot√≥n de eliminar (se mantiene igual)
      document.addEventListener("click", async (e) => {
          if (e.target.closest(".delete-btn")) {
              const tr = e.target.closest("tr");
              const idCell = tr.querySelector('td[data-id]');
              const id = idCell ? idCell.getAttribute('data-id') : null;

              if (!id) {
                  showError("No se pudo obtener el ID del cajero para eliminar.");
                  return;
              }

              if (!confirm(`¬øEst√°s seguro de que quieres eliminar el cajero con ID ${id}?`)) {
                  return;
              }
              
              try {
                  const res = await fetch(`${apiBase}/${id}`, {
                      method: "DELETE",
                  });

                  if (res.ok) {
                      alert("‚úÖ Cajero eliminado correctamente.");
                      deleteFrontendData(id); 
                  } else {
                      const error = await res.json();
                      const mensaje = error.detail || JSON.stringify(error);
                      alert(`‚ùå Error al eliminar:\n${mensaje}`);
                  }
              } catch (err) {
                  console.error(err);
                  alert("‚ö†Ô∏è Error de red al intentar eliminar el cajero.");
              }
          }
      });

      // üíæ Manejador para CREAR
      createForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const id = document.getElementById("createId").value.trim();
          const nombre = document.getElementById("createNombre").value.trim();
          const ciudad = document.getElementById("createCiudad").value.trim();
          const provincia = document.getElementById("createProvincia").value.trim();
          const pais = document.getElementById("createPais").value.trim();

          const payload = { id, nombre, ciudad, provincia, pais };

          try {
              // Siempre usamos POST, ya que solo es para crear
              const res = await fetch(`${apiBase}/`, { 
                  method: "POST", 
                  headers: {
                      "Content-Type": "application/json"
                  },
                  body: JSON.stringify(payload),
              });

              if (res.ok) {
                  const newCajero = await res.json();
                  alert(`‚úÖ Cajero ${newCajero.id} creado correctamente.`);
                  createModal.hide();

                  // Actualizar en memoria y renderizar
                  addFrontendData(newCajero);

              } else {
                  const error = await res.json();

                  console.error("Error al crear cajero:", error);

                  let mensaje = "";
                  if (typeof error === "string") {
                      mensaje = error;
                  } else if (error.detail) {
                      // Manejamos errores de validaci√≥n y de negocio (ej. ID duplicado)
                      mensaje = typeof error.detail === "string" ? error.detail : JSON.stringify(error.detail, null, 2);
                  } else {
                      mensaje = JSON.stringify(error);
                  }

                  alert(`‚ùå Error al crear:\n${mensaje}`);

              }
          } catch (err) {
              console.error(err);
              alert("‚ö†Ô∏è Error de red al intentar crear el cajero.");
          }
      });
  </script>
  </body>
</html>
